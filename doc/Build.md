# Queue Build Process

Like many modern webapps, the Queue utilizes a build system to transform and bundle source code into assets that are served to the client. We use [Next.js](https://github.com/zeit/next.js/) as the basis of the frontend tooling. Next.js takes care of client-side routing, splitting code across routes, transpiling JSX syntax, and more.

In April 2019, the Queue began adopting [TypeScript](https://www.typescriptlang.org/) for both client-side and server-side code. Because TypeScript is used on the server is well, this means we had to introduce a compilation step for the server code as well. Although Next.js supports custom servers, it doesn't have built-in support for transpiling said server code (see [this GitHub issue](https://github.com/zeit/next.js/issues/1735) for more context). To work around that, we have a somewhat nonstandard Next.js build phase. You can see the full command for this in `package.json` under the `build` script. The general process is explained below.

First, we copy all of the `src` files into a directory called `nextbuild` and run the standard Next.js build script in that directory (we use the [`@zeit/next-typescript`](https://github.com/zeit/next-plugins/tree/master/packages/next-typescript) plugin, which handles TypeScript for us in this phase). That outputs compiled assets (scripts, stylesheets, etc.) into the `nextbuild/.next` directory. Next, we invoke the TypeScript compiler (`tsc`) on the `src` directory to compile all of the server files into JavaScript files in a `build` directory. Note that even though all the React components and shared client/server code are compiled in this phase too, they aren't actually used anymore - only the bundled assets generated by the Next.js toolchain are ever seen on the client in production. Next, we copy the `nextbuild/.next` directory to `build/.next` - this leaves the source files (which are no longer neede) behind, and only includes the bundled assets that'll be served in production. Finally, we manually copy the static files from `src/static` to `build/static`, as the `tsc` compiler doesn't copy those for us.

The story is a little bit different in development, where we don't care about precompiling all the files. In development (`npm run dev`), we use [`node-ts`](https://github.com/TypeStrong/ts-node) to compile and execute TypeScript for us on the fly. You can also use [nodemon](https://nodemon.io/) via `npm run dev-watch`, which will restart the server when any files are changed. This is mostly only useful when working on the server side of things, as Next.js automatically hot-reloads client code when running in dev mode.
